#!/bin/bash

xpm=$(cat);

nl=$'\n'
legend=$(echo "$xpm" | cut -d '"' -f 2 | grep ' c ')
last=$(echo "$legend" | tail -1)
lineno=$(echo "$xpm" | grep -n "$last" | cut -d : -f 1)
((lineno++));
pixels=$(echo "$xpm" | tail -n "+${lineno}" | cut -d '"' -f 2 | grep -v "^/\*" | grep -v "^};")
declare -A color_lookup
while read -r line
do
    sp_cnt=$(echo "$line" | grep -o ' ' | wc -l)
    if [ $sp_cnt -eq 1 ]; then
        key=" "
        val=$(echo "$line" | cut -d 'c' -f 2 | cut -d ' ' -f 2)
    else
        key=$(echo "$line" | cut -d ' ' -f 1)
        val=$(echo "$line" | cut -d ' ' -f 3)
    fi
    color_lookup["$key"]="$val"
done <<< "$legend"
legend=

html='<html><HEAD><STYLE>
* { margin:0; padding:0; font-size:12px}
table, caption, tbody, tfoot, thead, tr, th, td {
    margin: 0;
    padding: 0;
    border: 0;
    outline: 0;
    border-collapse:collapse;
    /*font-size: 100%;*/
    /*vertical-align: baseline;*/
    /*background: transparent;*/
}
td {font-family: "Courier New";
border-spacing:0;
-webkit-border-horizontal-spacing: 0;
vertical-align: baseline;
font-size: 100%;
border-collapse: collapse;
}
td {
font-family: "Courier New";
font-size: 100%;
width:1px;
height:1px;
}
</STYLE></HEAD><body><table><tr>'
tr=1
tdl="<td style='background-color:"
tdr="'> </td>"
for ((i=0;i<${#pixels};i++));
do
    if [ $tr -eq 0 ]; then
        html="${html}<tr>"
        tr=1
    fi
    if [ "${pixels:$i:1}" = "$nl" ]; then
        html="${html}</tr>";
        echo "<!-- line -->"
        tr=0
    else
        p="${pixels:$i:1}"
        color=${color_lookup["$p"]}
        if [ "$color" = "None" ]; then
            html="${html}<td></td>"
        else
            html="${html}${tdl}${color}${tdr}"
        fi
    fi
done
html="${html}</table></body></html>"
echo "$html"
